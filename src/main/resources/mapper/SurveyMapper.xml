<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lcomputerstudy.form.mapper.SurveyMapper">
	<select id="selectSurvey" resultType="Survey">
		SELECT		s_idx  as sIdx,
					s_title as sTitle,
					s_datetime as sDateTime
		FROM		y_survey
	</select>
	
	<insert id="insertSurvey" parameterType="Survey" useGeneratedKeys="true" keyProperty="sIdx">
		INSERT INTO y_survey(
			s_idx,
			s_title, 
			s_datetime
		)
        VALUES (
        	#{sIdx},
        	#{sTitle}, 
        	now()
        )
        <selectKey keyProperty="sIdx" resultType="Integer" order="AFTER">
        	SELECT	last_insert_id()
        </selectKey>
	</insert>

	<insert id="insertQuestion" parameterType="Question" useGeneratedKeys="true" keyProperty="qIdx">
		INSERT INTO y_question(
			q_idx, 
			q_type, 
			q_question, 
			s_idx
		)
   		VALUES (
        	#{qIdx}, 
        	#{qType}, 
        	#{qQuestion}, 
        	#{sIdx}
        )
	</insert>
	<select id="selectquestionid" parameterType="Question">
		SELECT	q_idx as #{qIdx},
				q_type as #{qType},
				q_question as #{qQuestion},
				s_idx as #{sIdx}
		FROM	y_question
		WHERE	q_idx = 2
	</select>
	<insert id="insertOption" parameterType="Options">
		INSERT INTO y_option(
			o_idx,
			q_idx,
			o_option,
			s_idx
		)
		VALUES (
			#{oIdx},
        	#{qIdx}, 
        	#{oOption},
        	#{sIdx}
        )
	</insert>
	
	<update id="get">
		<selectKey keyProperty="qIdx" resultType="Integer" order="AFTER">
        	SELECT	q_idx as #{qIdx}
        	FROM	y_question
       		WHERE	q_type = 2 AND s_idx = #{sIdx}
        </selectKey>
        UPDATE	y_option
        SET		q_idx = #{qIdx}
        WHERE	s_idx = #{sIdx}
	</update>
	
	<select id="getqIdx">
		SELECT  q_idx as #{qIdx}
		FROM	y_question
		WHERE	q_type = 2
		LIMIT	1
	</select>
	<update id="getOptionqIdx" parameterType="Options">
		UPDATE	y_option
		SET		q_idx = (
			SELECT	q_idx
			FROM	y_question
			WHERE	q_type = 2
			ORDER BY s_idx DESC
        	LIMIT 1
		)
		WHERE s_idx = (
			SELECT	s_idx
			FROM	y_question
			WHERE	q_type = 2
			ORDER BY s_idx DESC
			LIMIT 1
		)
	</update>
	<select id="viewSurvey" parameterType="Integer" resultType="Survey">
		SELECT	s_idx as sIdx,
				s_title as sTitle
		FROM	y_survey
		WHERE	s_idx = #{sIdx}
	</select>
	
	<select id="viewQuestion" parameterType="Integer" resultType="Question">
		SELECT	s_idx as sIdx,
				q_idx as qIdx,
				q_type as qType,
				q_question as qQuestion
		FROM	y_question
		WHERE	s_idx = #{sIdx}
	</select>
	
	<select id="viewOption" parameterType="Integer" resultType="Options">
		SELECT	o_idx as oIdx,
				s_idx as sIdx,
				q_idx as qIdx,
				o_option as oOption
		FROM	y_option
		WHERE	s_idx = #{sIdx}
	</select>
	
	<insert id="insertAnswer" parameterType="Answer">
		INSERT INTO y_answer(
			o_idx,
			q_idx,
			a_answer,
			s_idx
		)
		VALUES (
			#{oIdx},
        	#{qIdx}, 
        	#{oOption},
        	#{sIdx}
        )
	</insert>
	
	<select id="viewAnswers" parameterType="Integer" resultType="Answer">
		SELECT	o_idx as oIdx,
				s_idx as sIdx,
				q_idx as qIdx,
				a_answer as oOption
		FROM	y_answer
		WHERE	s_idx = #{sIdx}
	</select>
	
	<select id="viewAnswer" parameterType="Integer" resultType="Answer">
		SELECT	count(*) as count
		FROM	y_answer
		WHERE	s_idx = #{sIdx}
	</select>
	
	<insert id="insertallAnswer">
		INSERT INTO y_allanswer(
			a_answer,
			s_idx
		)
		VALUES (
        	#{aAnswer},
        	#{sIdx}
        )
	</insert>
	
	<insert id="insertResponse">
		INSERT INTO y_allanswer(
			a_answer,
			s_idx
		)
		VALUES (
        	#{aAnswer},
        	#{sIdx}
        )
	</insert>
	
</mapper>

